# 認証ドメインのリスク

認証システムのアーキテクチャと実装に固有のリスク。

## 1. トークン更新の競合状態

- **詳細**: 複数のフロントエンドリクエストが同時に発生し、それぞれがリフレッシュトークンを使用しようとする場合、あるリクエストがトークンを無効にしてから他のリクエストが完了する前に、強制ログアウトが発生する可能性がある。
- **対策**: フロントエンドにトークン更新キュー/ミューテックスを実装、トークン有効性にスライディングウィンドウを使用。
- **関連インシデント**: `incidents/2023-login-failure.md`

## 2. SSO属性マッピング失敗

- **詳細**: IdP側の仕様変更により、特定の属性（メールなど）が利用不可またはフォーマット変更される可能性がある。
- **対策**:
  - 欠落属性の適切なフォールバックを実装
  - IdPメタデータ変更を監視
  - アカウント作成前に属性存在を検証

## 3. セッションストア障害

- **詳細**: Redis接続障害により、認証済みユーザーがすべてのセッションを同時に喪失する。
- **対策**:
  - 高可用性のためのRedisクラスター構成
  - セッション操作のサーキットブレーカー
  - グレースフルデグラデーション（バックアップから読み込み）

## 4. パスワードリセットトークンの露出

- **詳細**: URL内のパスワードリセットトークンがサーバーアクセスログ、ブラウザ履歴、またはリファラーヘッダーにログされる可能性がある。
- **対策**:
  - 短寿命トークンを使用（最大1時間）
  - 即座に無効化される単一使用トークン
  - URL パラメータの代わりにPOSTベースのトークン送信

## 5. 並行セッションハイジャック

- **詳細**: 適切なセッションバインディングなしで、セッショントークンを取得した攻撃者が異なるデバイス/ロケーションから使用できる。
- **対策**:
  - セッションをデバイスフィンガープリントにバインド
  - 疑わしいセッションアクティビティに警告
  - セッション取り消しUIを実装
