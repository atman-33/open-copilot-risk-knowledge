# 決済ドメインのリスク

決済システムのアーキテクチャと実装に固有のリスク。

## 1. 二重請求

- **詳細**: ネットワーク問題または再試行ロジックにより、顧客が単一のオーダーで複数回請求される可能性がある。
- **対策**:
  - すべての決済リクエストにべき等キーを実装
  - 新しいトランザクション開始前に既存トランザクションをチェック
  - トランザクション参照にデータベースレベルの制約を使用
- **重要度**: 重大（経済的損失、顧客信頼）

## 2. 決済データ露出

- **詳細**: クレジットカード番号またはその他の機密決済データがログ、エラーメッセージ、APIレスポンスで露出。
- **対策**:
  - フルカード番号をログに記録しない（最後の4桁にマスク）
  - トークン化を使用 - 生カード データを保存しない
  - すべての決済処理でPCI DSS準拠
- **重要度**: 重大（規制違反、データ漏洩）
- **関連インシデント**: `incidents/2024-data-leak-api.md`

## 3. PSP統合失敗

- **詳細**: 決済サービスプロバイダーAPIが利用不可になり、すべての決済処理がブロックされる。
- **対策**:
  - サーキットブレーカーパターンを実装
  - フェイルオーバーPSPを設定
  - 決済不可についてユーザーに明確に伝える
- **重要度**: 重大（収益損失）

## 4. 払い戻し詐欺

- **詳細**: 競合状態またはバリデーションギャップを利用した悪意のある払い戻しリクエスト。
- **対策**:
  - 元のトランザクションに対して払い戻し金額を検証
  - 払い戻し速度チェックを実装
  - 大規模払い戻しに対して追加認可を要求

## 5. 通貨換算エラー

- **詳細**: 不正な為替レートまたは丸め誤差による経済的矛盾。
- **対策**:
  - すべての金銭計算にdecimal型を使用
  - トランザクション開始時に為替レートをロック
  - PSPステートメントとの調整チェック
