# インシデント: 2023年ログイン障害

## サマリー

- **日時**: 2023-03-15
- **継続時間**: 4時間（JST 09:00 - 13:00）
- **重要度**: 重大
- **影響を受けたユーザー**: すべてのユーザー（100%）

## インシデント説明

すべてのユーザーがアプリケーションにログインできなかった。すでにログインしていたユーザーが認証が必要なアクションを試みるとセッションを喪失した。

## 根本原因

デプロイメントが認証APIのレスポンス形式を更新し、トークンフィールド名が`access_token`から`accessToken`に変更された。フロントエンドはこの変更に対応するために更新されなかったため、すべてのトークン解析が失敗した。

さらに、ユーザーが複数回ページをリフレッシュしようとした際に、リフレッシュトークンの競合状態バグが発動し、トークンが正しく保存される前に無効化された。

## タイムライン

| 時刻 | イベント |
|------|-------|
| 09:00 | デプロイメント完了 |
| 09:05 | 最初のユーザーがログイン障害を報告 |
| 09:30 | インシデントをP1にエスカレート |
| 10:00 | 根本原因を特定 |
| 12:00 | ホットフィックスをデプロイ |
| 13:00 | すべてのサービスを復旧 |

## 影響

- 4時間の完全なビジネス停止
- カスタマーサポートはチケットで圧倒される
- 推定収益損失: $50,000

## 教訓

1. APIレスポンス形式の変更には、フロントエンド/バックエンドの調整されたデプロイが必要
2. トークン更新ロジックには、競合状態を防ぐためにミューテックス/キューが必要
3. カナリアデプロイメントには認証フロータイムテストを含める必要がある

## 関連リスク

- `domains/auth/risks.md` - トークン更新競合状態
- `common-risks/availability.md` - ログイン/認証失敗

## アクションアイテム

- [x] APIバージョン管理を実装
- [x] フロントエンドにトークン更新キューを追加
- [x] デプロイメントパイプラインに認証スモークテストを追加
