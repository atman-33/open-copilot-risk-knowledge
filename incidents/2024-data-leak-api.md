# インシデント: 2024年APIデータリーク

## サマリー

- **日時**: 2024-01-22
- **継続時間**: 6時間（発見から封じ込めまで）
- **重要度**: 重大
- **影響を受けたユーザー**: 約5,000ユーザー

## インシデント説明

セキュリティ研究者が、決済履歴APIエンドポイントがマスクされた値の代わりに完全なクレジットカード番号を返していることを報告した。この脆弱性は約2週間稼働していた。

## 根本原因

決済モジュールのリファクタリング中に、開発者が誤ってカード番号マスキングロジックを削除した。コードレビューは50個以上のファイル変更を含む大規模PRの一部であったため、この変更を見逃した。

元のコード:
```
return { cardNumber: maskCardNumber(payment.cardNumber) }
```

変更後:
```
return { cardNumber: payment.cardNumber }
```

## タイムライン

| 時刻 | イベント |
|------|-------|
| 14:00 | セキュリティ研究者が脆弱性を報告 |
| 14:30 | セキュリティチームが問題を確認 |
| 15:00 | インシデントをP0にエスカレート |
| 16:00 | ホットフィックスを本番環境にデプロイ |
| 18:00 | 影響を受けたユーザーを特定 |
| 20:00 | ユーザー通知を送信 |

## 影響

- PCI DSS規制違反
- 規制当局への義務的な違反通知
- 約5,000の潜在的に影響を受けるユーザーに通知
- 推定是正コスト: $200,000

## 教訓

1. セキュリティクリティカルなコード変更には専門的なレビューが必要
2. 大規模PRは重要な変更を隠す - PR サイズ制限を実施
3. 自動テストはAPIレスポンスのデータマスキングを検証する必要がある
4. セキュリティスキャンはAPIレスポンスのPIIをチェックする必要がある

## 関連リスク

- `domains/payment/risks.md` - 決済データ露出
- `common-risks/security.md` - 情報開示

## アクションアイテム

- [x] APIレスポンスの自動PII検出を実装
- [x] 最大PRサイズ20ファイルを実施
- [x] セキュリティ重視のコードレビューチェックリストを追加
- [x] 影響を受けたユーザーのクレジット監視を実装
- [ ] PCI DSS再認定監査を完了
